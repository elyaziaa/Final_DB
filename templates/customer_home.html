<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Customer Home</title>
        <style>
            /* Bar chart styles */
            .chart {
                display: flex;
                align-items: flex-end;
                height: 300px;
                padding: 20px;
                margin: 20px 0;
                background: #f5f5f5;
                border-radius: 8px;
                gap: 20px;
                justify-content: space-around;
            }
    
            .bar-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 60px;
            }
    
            .bar {
                width: 100%;
                background-color: #4f46e5;
                transition: height 0.3s;
                border-radius: 4px 4px 0 0;
                position: relative;
                min-height: 1px;
            }
    
            .amount {
                position: absolute;
                top: -25px;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 12px;
            }
    
            .month {
                margin-top: 10px;
                font-size: 12px;
                transform: rotate(-45deg);
                text-align: center;
                white-space: nowrap;
            }
        </style>
    </head>
<body>
   <h1>Welcome, {{ first_name }}!</h1>
   <a href="/logout">Logout</a>
   <hr>

<!-- View My Flights Section -->
<h2>View My Flights</h2>
<a href="/view_flights?type=future">Future Flights</a> |
<a href="/view_flights?type=past">Past Flights</a>

<!-- Future Flights Table -->
{% if query_type == 'future' and flights %}
    <h3>Future Flights</h3>
    <table border="1">
        <tr>
            <th>Flight Number</th>
            <th>Departure Airport</th>
            <th>Arrival Airport</th>
            <th>Departure Date</th>
            <th>Departure Time</th>
            <th>Arrival Date</th>
            <th>Arrival Time</th>
            <th>Status</th>
            <th>Ticket ID</th>
        </tr>
        {% for flight in flights %}
        <tr>
            <td>{{ flight['Flight_Num'] }}</td>
            <td>{{ flight['Departure_Code'] }}</td>
            <td>{{ flight['Arrival_Code'] }}</td>
            <td>{{ flight['Departure_Date'] }}</td>
            <td>{{ flight['Departure_Time'] }}</td>
            <td>{{ flight['Arrival_Date'] }}</td>
            <td>{{ flight['Arrival_Time'] }}</td>
            <td>{{ flight['Flight_Status'] }}</td>
            <td>{{ flight['Ticket_ID'] }}</td>
        </tr>
        {% endfor %}
    </table>
{% endif %}

<!-- Past Flights Table -->
{% if query_type == 'past' and flights %}
    <h3>Past Flights</h3>
    <table border="1">
        <tr>
            <th>Flight Number</th>
            <th>Departure Airport</th>
            <th>Arrival Airport</th>
            <th>Departure Date</th>
            <th>Arrival Date</th>
            <th>Status</th>
            <th>Ticket ID</th>
        </tr>
        {% for flight in flights %}
        <tr>
            <td>{{ flight['Flight_Num'] }}</td>
            <td>{{ flight['Departure_Code'] }}</td>
            <td>{{ flight['Arrival_Code'] }}</td>
            <td>{{ flight['Departure_Date'] }}</td>
            <td>{{ flight['Arrival_Date'] }}</td>
            <td>{{ flight['Flight_Status'] }}</td>
            <td>{{ flight['Ticket_ID'] }}</td>
        </tr>
        {% endfor %}
    </table>
{% endif %}

   <!-- Flight Search Section -->
   <div>
       <h2>Flight Search</h2>
       <form action="/search_flights" method="POST">
           <input type="hidden" name="target_page" value="customer_home">
          
           <label for="departure_code">Departure Airport Code:</label>
           <input type="text" id="departure_code" name="departure_code" required><br><br>

           <label for="arrival_code">Arrival Airport Code:</label>
           <input type="text" id="arrival_code" name="arrival_code" required><br><br>

           <label for="trip_type">Trip Type:</label>
           <select id="trip_type" name="trip_type" required>
               <option value="one-way">One Way</option>
               <option value="round-trip">Round Trip</option>
           </select><br><br>

           <label for="departure_date">Departure Date:</label>
           <input type="date" id="departure_date" name="departure_date" required><br><br>

           <div id="return_date_section" style="display: none;">
               <label for="return_date">Return Date:</label>
               <input type="date" id="return_date" name="return_date"><br><br>
           </div>

           <button type="submit">Search Flights</button>
       </form>

       <!-- Flight Results Section -->
       {% if flights or has_past_flights %}
           {% if has_past_flights %}
               <p style="color: red; font-weight: bold;">
                   Note: This flight search will only display future flights, you entered a past flight!
               </p>
           {% endif %}
          
           {% if flights %}
               <h3>Search Results</h3>
               <table border="1">
                   <tr>
                       <th>Flight Number</th>
                       <th>Departure Airport</th>
                       <th>Arrival Airport</th>
                       <th>Departure Date</th>
                       <th>Departure Time</th>
                       <th>Arrival Date</th>
                       <th>Arrival Time</th>
                       <th>Base Ticket Price</th>
                       <th>Flight Status</th>
                       <th>Airline Name</th>
                   </tr>
                   {% for flight in flights %}
                       <tr>
                           <td>{{ flight['Flight_Num'] }}</td>
                           <td>{{ flight['Departure_Airport'] }} ({{ flight['Departure_Code'] }})</td>
                           <td>{{ flight['Arrival_Airport'] }} ({{ flight['Arrival_Code'] }})</td>
                           <td>{{ flight['Departure_Date'] }}</td>
                           <td>{{ flight['Departure_Time'] }}</td>
                           <td>{{ flight['Arrival_Date'] }}</td>
                           <td>{{ flight['Arrival_Time'] }}</td>
                           <td>{{ flight['Base_Ticket_Price'] }}</td>
                           <td>{{ flight['Flight_Status'] }}</td>
                           <td>{{ flight['Airline_Name'] }}</td>
                       </tr>
                   {% endfor %}
               </table>
           {% else %}
               <p>No flights match your search criteria.</p>
           {% endif %}
       {% endif %}
   </div>

   <hr>
   <h2>Check Available Seats</h2>
   <form id="seatCheckForm">
       <label for="flight_num_check">Enter Flight Number:</label>
       <input type="number" id="flight_num_check" name="flight_num_check" required>
       <button type="button" onclick="checkSeats()">Check Available Seats</button>
   </form>

   <!-- Seats will be displayed here -->
   <div id="seatsDisplay">
       <h3>Available Seats, click to select:</h3>
       <div id="seatsList"></div>
   </div>

   <!-- Purchase Tickets Section -->
   <hr>
   <h2>Purchase Tickets</h2>
   <form action="/purchase_ticket" method="POST">
       <label for="flight_num">Flight Number:</label>
       <input type="number" id="flight_num" name="flight_num" required><br><br>

       <label for="seat_number">Seat Number:</label>
       <input type="text" id="seat_number" name="seat_number" required><br><br>

       <label for="card_number">Payment Card Number:</label>
       <input type="text" id="card_number" name="card_number" required><br><br>

       <button type="submit">Purchase Ticket</button>
   </form>

   <hr>
   <!-- Cancel Trip Section -->
   <h2>Cancel Trip</h2>
   <form action="/cancel_ticket" method="POST">
       <label for="ticket_id">Ticket ID to Cancel:</label>
       <input type="number" id="ticket_id" name="ticket_id" required><br><br>
       <button type="submit">Cancel Ticket</button>
   </form>

   <hr>
   <!-- Rate Flight Section -->
   <h2>Rate a Flight</h2>
   {% if flights_to_rate %}
       <form action="/rate_flight" method="POST">
           <label for="flight_num">Select a Flight:</label>
           <select id="flight_num" name="flight_num" required>
               {% for flight in flights_to_rate %}
                   <option value="{{ flight.Flight_Num }}">
                       {{ flight.Flight_Num }} - {{ flight.Departure_Code }} to {{ flight.Arrival_Code }} on {{ flight.Departure_Date }}
                   </option>
               {% endfor %}
           </select><br><br>
   
           <label for="rating">Rating (1-5):</label>
           <input type="number" id="rating" name="rating" min="1" max="5" required><br><br>
   
           <label for="comment">Comment (optional):</label>
           <textarea id="comment" name="comment"></textarea><br><br>
   
           <button type="submit">Submit Rating</button>
       </form>
   {% else %}
       <p>No flights available for rating at this time. You have either already rated all your past flights, or have not had any yet...</p>
   {% endif %}

   <script>
   // JavaScript to show/hide the return date field
   document.getElementById("trip_type").addEventListener("change", function() {
       var returnDateSection = document.getElementById("return_date_section");
       if (this.value === "round-trip") {
           returnDateSection.style.display = "block";
       } else {
           returnDateSection.style.display = "none";
       }
   });

   // Function to check seats
   function checkSeats() {
       const flightNum = document.getElementById('flight_num_check').value;
       if (!flightNum) {
           alert('Please enter a flight number');
           return;
       }

       fetch(`/select_seat/${flightNum}`)
           .then(response => response.json())
           .then(data => {
               if (data.error) {
                   alert(data.error);
                   return;
               }

               const seatsList = document.getElementById('seatsList');
               seatsList.innerHTML = '';

               const table = document.createElement('table');
               table.border = '1';
               
               const header = table.insertRow();
               header.innerHTML = '<th>Seat Number</th><th>Status</th><th>Action</th>';

               data.seats.forEach(seat => {
                   const row = table.insertRow();
                   const seatCell = row.insertCell(0);
                   const statusCell = row.insertCell(1);
                   const actionCell = row.insertCell(2);

                   seatCell.textContent = seat.Seat_Number;
                   statusCell.textContent = seat.Is_Available ? 'Available' : 'Taken';

                   if (seat.Is_Available) {
                       const selectButton = document.createElement('button');
                       selectButton.textContent = 'Select';
                       selectButton.onclick = function() {
                           document.getElementById('flight_num').value = flightNum;
                           document.getElementById('seat_number').value = seat.Seat_Number;
                       };
                       actionCell.appendChild(selectButton);
                   } else {
                       actionCell.textContent = 'Not Available';
                   }
               });

               seatsList.appendChild(table);
           })
           .catch(error => {
               console.error('Error:', error);
               alert('Error loading seats. Please try again.');
           });
   }
   </script>

    
    <hr>
    <h2>Track My Spending</h2>
<div id="defaultSpendingView">
    <h3>Last 6 Months Spending</h3>
    <p>Total Spent: ${{ '%.2f' | format(total_spent) if total_spent else '0.00' }}</p>
    
    <div class="chart">
        {% for data in spending_data %}
        <div class="bar-container">
            <div class="bar" style="height: {{ data.height }}%">
                <span class="amount">${{ '%.2f' | format(data.amount) }}</span>
            </div>
            <span class="month">{{ data.month }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<form action="/track_spending" method="POST" id="spendingForm">
    <label for="start_date">Start Date:</label>
    <input type="date" id="start_date" name="start_date" required><br><br>
    
    <label for="end_date">End Date:</label>
    <input type="date" id="end_date" name="end_date" required><br><br>
    
    <button type="submit">View Spending</button>
</form>

<div id="customDateSpending"></div>

<script>
document.getElementById('spendingForm').onsubmit = function(e) {
    e.preventDefault();
    fetch('/track_spending', {
        method: 'POST',
        body: new FormData(this)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        displaySpendingData(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error fetching spending data');
    });
};

function displaySpendingData(data) {
    const resultDiv = document.getElementById('customDateSpending');
    resultDiv.innerHTML = `
        <h3>Custom Date Range Spending</h3>
        <p>Total Spent: $${data.total_spent.toFixed(2)}</p>
        <div class="chart">
            ${data.spending_data.map(data => `
                <div class="bar-container">
                    <div class="bar" style="height: ${data.height}%">
                        <span class="amount">$${data.amount.toFixed(2)}</span>
                    </div>
                    <span class="month">${data.month}</span>
                </div>
            `).join('')}
        </div>
    `;
}
</script>

</body>
</html>